


--/*************************************************/

--Declare @SQL_Sting as varchar(max) = 'Surya ( from ) (21313312321) (21313312321) '


DROP TABLE IF EXISTS #SQL_Sting_brack_location;
Create table  #SQL_Sting_brack_location (Bracketloc int identity ,Open_Bracket_Location int, Close_Bracket_Location int)


Declare @SQL_Sting as varchar(max) 
=
'SELECT 
 S.Name
,T.Unit_Sold
FROM 
    (
    Select 
    	    ProductID
    	  , Unit_Sold
    
    FROM [Sales].[SalesOrderDetail]
    ) T,
    (
    Select 
    	   ProductID	
		  , Name
    FROM [Production].[Product]
    ) S
Where T.ProductID = S.ProductID'

Declare @SQL_Sub_Sting as varchar(max) 
Declare @SQL_Sting_len as int = Len(@SQL_Sting)
Declare @SQL_Sting_Open_brack_loc as int = 0



--Select SUBSTRING(@SQL_Sting, (CHARINDEX(')', @SQL_Sting) +1) , Len(@SQL_Sting) )

/****** FIND ALL THE OPEN BRACKETS IN THE SQL STATEMENT ******/

DECLARE @Counter_Open INT 
SET @Counter_Open=0
WHILE ( @Counter_Open <= @SQL_Sting_Len)
BEGIN
	SET @SQL_Sub_Sting = (SELECT SUBSTRING(@SQL_Sting,@Counter_Open, @SQL_Sting_len))

	--print(@SQL_Sub_Sting)
    Set @SQL_Sting_Open_brack_loc = CHARINDEX('(', @SQL_Sub_Sting) 
	Insert into #SQL_Sting_brack_location (Open_Bracket_Location) Values (@SQL_Sting_Open_brack_loc)

	--Print(@SQL_Sting_Open_brack_loc)
	set @Counter_Open = (SELECT CASE WHEN @SQL_Sting_Open_brack_loc = 0 then @Counter_Open + @SQL_Sting_Len +1
							   ELSE @Counter_Open + @SQL_Sting_Open_brack_loc +1 END )

	--print(@Counter_Open)
END


/****** FIND ALL THE OPEN BRACKETS IN THE SQL STATEMENT ******/


--DROP TABLE IF EXISTS #SQL_Sting_brack_location1;
--Create table  #SQL_Sting_brack_location1 (Bracketloc int identity ,Open_Bracket_Location int, Close_Bracket_Location int)



Declare @SQL_Sting_Closed_brack_loc as varchar(max)
Declare @identity_loc as int = 1
Declare @SQL_Sting_Closed_brack_loc_old as int = 0

DECLARE @Counter_Closed INT 
SET @Counter_Closed=0
WHILE ( @Counter_Closed <= @SQL_Sting_Len)
BEGIN
	SET @SQL_Sub_Sting = (SELECT SUBSTRING(@SQL_Sting,@Counter_Closed, @SQL_Sting_len))

	--print(@SQL_Sub_Sting)
    Set @SQL_Sting_Closed_brack_loc = CHARINDEX(')', @SQL_Sub_Sting) 
	--Insert into #SQL_Sting_brack_location1 (Close_Bracket_Location) Values (@SQL_Sting_Closed_brack_loc + @SQL_Sting_Closed_brack_loc_old)

	Update #SQL_Sting_brack_location
	SET Close_Bracket_Location = @SQL_Sting_Closed_brack_loc + @SQL_Sting_Closed_brack_loc_old
	Where Bracketloc = @identity_loc

	--Print(@SQL_Sting_Closed_brack_loc)
	set @Counter_Closed = (SELECT CASE WHEN @SQL_Sting_Closed_brack_loc = 0 then @Counter_Closed + @SQL_Sting_Len +1
							   ELSE @SQL_Sting_Closed_brack_loc + @SQL_Sting_Closed_brack_loc_old +1 END )
	SET @identity_loc = @identity_loc + 1
	SET @SQL_Sting_Closed_brack_loc_old = @SQL_Sting_Closed_brack_loc + @SQL_Sting_Closed_brack_loc_old

	--print(@Counter_Closed)
END


